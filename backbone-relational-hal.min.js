/*!
 * backbone-relational-hal v0.1.0
 * Copyright (c) 2014 Simon Oulevay
 * Distributed under MIT license
 * https://github.com/AlphaHydrae/backbone-relational-hal
 */
!function(a,b){var c=a.Collection,d=a.RelationalModel,e=d.extend({href:function(){return this.get("href")},tag:function(a,b){return b=b||{},$("<a />").attr("href",this.get("href"))[b.html?"html":"text"](a)}}),f=(c.extend({model:e}),d.extend({link:function(a,c){if(c=b.extend({},c),c.required&&!this.has(a))throw new Error("No link found with relation "+a);var d=this.get(a);if("undefined"==typeof d.length)return d;var e=c.type,f=d.filter(function(a){return a.has("type")&&a.get("type")==e});if(!f.length)throw new Error("No link found with relation "+a+" and type "+e);if(f.length>=2)throw new Error("Multiple links found with relation "+a+" and type "+e);return b.first(f)}})),g=d.extend({embedded:function(a){return this.get(a)}}),h=a.RelationalHalResource=d.extend({url:function(){return this.hasLink("self")?this.link("self").href():null},link:function(){var a=this.get("_links");if(!a)throw new Error("Resource has no _links property.");return a.link.apply(a,Array.prototype.slice.call(arguments))},hasLink:function(a){return this.has("_links")&&this.get("_links").has(a)},embedded:function(){var a=this.get("_embedded");return a?a.embedded.apply(a,Array.prototype.slice.call(arguments)):null},hasEmbedded:function(a){return this.has("_embedded")&&this.get("_embedded").has(a)},hasSameUri:function(a){return a?this.link("self").get("href")==a.link("self").get("href"):!1},isNew:function(){return!this.hasLink("self")}}),i=h.extend;h.extend=function(c){c=b.defaults({},c,{relations:[],halLinks:[],halEmbedded:[]});var d=f.extend({relations:b.map(c.halLinks,function(c){return b.defaults({},b.isObject(c)?c:{key:c},{type:a.HasOne,relatedModel:e})})}),j=g.extend({relations:b.map(c.halEmbedded,function(a){return b.clone(a)})});return c.relations.push({type:a.HasOne,key:"_links",relatedModel:d,includeInJSON:!1}),c.relations.push({type:a.HasOne,key:"_embedded",relatedModel:j,includeInJSON:!1}),i.call(h,c)},a.fetchHalHref=function(c,d,e){e=e||$.Deferred();var f;if(d){if(!b.isObject(d._links))throw new Error("Expected source to have a links in the _links property, got "+JSON.stringify(d));var g=c.shift(),h=d._links[g.rel];if(!h)throw new Error("Expected source links to have a "+g.rel+" link, got "+b.keys(d._links).join(", "));if(!h.href)throw new Error("Expected source link "+g.rel+" to have an href property, got "+JSON.stringify(h));if(g.template&&!h.templated)throw new Error("Template parameters were given for link "+g.rel+" but it is not templated, got "+JSON.stringify(h));f=h.href,g.template&&(f=new UriTemplate(f),f=f.fillFromObject(g.template))}else f=ApiPath.build();return c.length?(App.debug("Fetching HAL link "+c[0].rel+" from "+f),$.ajax({url:f,type:"GET",dataType:"json"}).done(function(b){a.fetchHalHref(c,b,e)}).fail(function(){e.reject("Could not GET "+f)}),e):(App.debug("HAL link is "+f),e.resolve(f),e)},a.originalSync=a.sync,a.sync=function(c,d,e){e=b.clone(e)||{};var f=null;try{f=e.url||b.result(d,"url")}catch(g){}var h=b.result(d,"halCachedUrl");if(h||d.halUrl||(h=b.result(d.collection,"halCachedUrl")),!f&&h&&(f=h,e.url=h),f)return a.originalSync.apply(a,Array.prototype.slice.call(arguments));var i=b.result(d,"halUrl"),j=d;if(i||(i=b.result(d.collection,"halUrl"),j=d.collection),!i)throw new Error("Model/collection must have url or halUrl.");e.attrs||(e.attrs=d.toJSON(e));var k=Array.prototype.slice.call(arguments),l=$.Deferred();return a.fetchHalHref(i.slice()).fail(b.bind(l.reject,l)).done(function(c){e.url=c,j.halCachedUrl=c,a.originalSync.apply(a,k).done(b.bind(l.resolve,l)).fail(b.bind(l.reject,l))}),l}}(Backbone,_);